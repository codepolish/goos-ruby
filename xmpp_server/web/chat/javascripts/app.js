(function(){this.ChatPage=function(){function a(a){var b=this;this.session=a,this.session.onRoster(function(){return b.roster()}),this.session.onCard(function(a){return b.card(a)}),this.session.onMessage(function(a){return b.message(a)}),this.session.onPresence(function(a){return b.presence(a)}),this.chats={},this.currentContact=null,this.layout=null}return a.prototype.datef=function(a){var b,c,d,e;return b=new Date(a),d=b.getHours()>=12?" pm":" am",c=b.getHours()>12?b.getHours()-12:b.getHours(),c===0&&(c=12),e=b.getMinutes()+"",e.length===1&&(e="0"+e),c+":"+e+d},a.prototype.card=function(a){var b=this;return this.eachContact(a.jid,function(c){return $(".vcard-img",c).attr("src",b.session.avatar(a.jid))})},a.prototype.roster=function(){var a,b,c,d,e,f,g,h,i=this;e=$("#roster"),$("li",e).each(function(a,b){var c;c=$(b).attr("data-jid");if(!i.session.roster[c])return $(b).remove()}),f=function(a,b){return $(".text",a).text(b.name||b.jid),a.attr("data-name",b.name||"")},g=this.session.roster,h=[];for(c in g)a=g[c],b=$("#roster li[data-jid='"+c+"']"),f(b,a),b.length===0?(d=$('<li data-jid="'+c+'" data-name="" class="offline">\n  <span class="text"></span>\n  <span class="status-msg">Offline</span>\n  <span class="unread" style="display:none;"></span>\n  <img class="vcard-img" alt="'+c+'" src="'+this.session.avatar(c)+'"/>\n</li>').appendTo(e),f(d,a),h.push(d.click(function(a){return i.selectContact(a)}))):h.push(void 0);return h},a.prototype.message=function(a){var b,c,d,e;if(a.type!=="chat"||!a.text)return;this.queueMessage(a),e=a.from===this.session.jid(),d=a.from.split("/")[0];if(!e&&d!==this.currentContact)return c=this.chat(a.from),c.unread++,this.eachContact(d,function(a){return $(".unread",a).text(c.unread).show()});b=this.atBottom(),this.appendMessage(a);if(b)return this.scroll()},a.prototype.eachContact=function(a,b){var c,d,e,f,g;f=$("#roster li[data-jid='"+a+"']").get(),g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(b($(c)));return g},a.prototype.appendMessage=function(a){var b,c,d,e;return c=a.from.split("/")[0],b=this.session.roster[c],d=b?b.name||c:c,a.from===this.session.jid()&&(d="Me"),e=$('<li data-jid="'+c+'" style="display:none;">\n  <p></p>\n  <img alt="'+c+'" src="'+this.session.avatar(c)+'"/>\n  <footer>\n    <span class="author"></span>\n    <span class="time">'+this.datef(a.received)+"</span>\n  </footer>\n</li>").appendTo("#messages"),$("p",e).text(a.text),$(".author",e).text(d),e.fadeIn(200)},a.prototype.queueMessage=function(a){var b,c,d;return d=a.from===this.session.jid(),c=a[d?"to":"from"],b=this.chat(c),b.jid=c,b.messages.push(a)},a.prototype.chat=function(a){var b,c;return b=a.split("/")[0],c=this.chats[b],c||(c={jid:a,messages:[],unread:0},this.chats[b]=c),c},a.prototype.presence=function(a){var b,c,d,e=this;c=a.from.split("/")[0];if(c===this.session.bareJid())return;if(!a.type||a.offline)b=this.session.roster[c],this.eachContact(c,function(a){return $(".status-msg",a).text(b.status()),b.offline()?a.addClass("offline"):a.removeClass("offline")});a.offline&&(this.chat(c).jid=c);if(a.type==="subscribe")return d=$('<li data-jid="'+a.from+'" style="display:none;">\n  <form class="inset">\n    <h2>Buddy Approval</h2>\n    <p>'+a.from+' wants to add you as a buddy.</p>\n    <fieldset class="buttons">\n      <input type="button" value="Decline"/>\n      <input type="submit" value="Accept"/>\n    </fieldset>\n  </form>\n</li>').appendTo("#notifications"),d.fadeIn(200),$("form",d).submit(function(){return e.acceptContact(d,a.from)}),$('input[type="button"]',d).click(function(){return e.rejectContact(d,a.from)})},a.prototype.acceptContact=function(a,b){return a.fadeOut(200,function(){return a.remove()}),this.session.sendSubscribed(b),this.session.sendSubscribe(b),!1},a.prototype.rejectContact=function(a,b){return a.fadeOut(200,function(){return a.remove()}),this.session.sendUnsubscribed(b)},a.prototype.selectContact=function(a){var b,c,d,e,f,g,h;d=$(a.currentTarget).attr("data-jid"),c=this.session.roster[d];if(this.currentContact===d)return;this.currentContact=d,$("#roster li").removeClass("selected"),$(a.currentTarget).addClass("selected"),$("#chat-title").text("Chat with "+(c.name||c.jid)),$("#messages").empty(),b=this.chats[d],e=[],b&&(e=b.messages,b.unread=0,this.eachContact(d,function(a){return $(".unread",a).text("").hide()}));for(g=0,h=e.length;g<h;g++)f=e[g],this.appendMessage(f);return this.scroll(),$("#remove-contact-msg").html("Are you sure you want to remove "+("<strong>"+this.currentContact+"</strong> from your buddy list?")),$("#remove-contact-form .buttons").fadeIn(200),$("#edit-contact-jid").text(this.currentContact),$("#edit-contact-name").val(this.session.roster[this.currentContact].name),$("#edit-contact-form input").fadeIn(200),$("#edit-contact-form .buttons").fadeIn(200)},a.prototype.scroll=function(){var a;return a=$("#messages"),a.animate({scrollTop:a.prop("scrollHeight")},400)},a.prototype.atBottom=function(){var a,b;return b=$("#messages"),a=b.prop("scrollHeight")-b.outerHeight(),b.scrollTop()>=a},a.prototype.send=function(){var a,b,c,d;return this.currentContact?(b=$("#message"),d=b.val().trim(),d&&(a=this.chats[this.currentContact],c=a?a.jid:this.currentContact,this.message({from:this.session.jid(),text:d,to:c,type:"chat",received:new Date}),this.session.sendMessage(c,d)),b.val(""),!1):!1},a.prototype.addContact=function(){var a;return this.toggleForm("#add-contact-form"),a={jid:$("#add-contact-jid").val(),name:$("#add-contact-name").val(),groups:["Buddies"]},a.jid&&this.session.updateContact(a,!0),!1},a.prototype.removeContact=function(){return this.toggleForm("#remove-contact-form"),this.session.removeContact(this.currentContact),this.currentContact=null,$("#chat-title").text("Select a buddy to chat"),$("#messages").empty(),$("#remove-contact-msg").html("Select a buddy in the list above to remove."),$("#remove-contact-form .buttons").hide(),$("#edit-contact-jid").text("Select a buddy in the list above to update."),$("#edit-contact-name").val(""),$("#edit-contact-form input").hide(),$("#edit-contact-form .buttons").hide(),!1},a.prototype.updateContact=function(){var a;return this.toggleForm("#edit-contact-form"),a={jid:this.currentContact,name:$("#edit-contact-name").val(),groups:this.session.roster[this.currentContact].groups},this.session.updateContact(a),!1},a.prototype.toggleForm=function(a,b){var c=this;return a=$(a),$("form.overlay").each(function(){if(this.id!==a.attr("id"))return $(this).hide()}),a.is(":hidden")?(b&&b(),a.fadeIn(100)):a.fadeOut(100,function(){a[0].reset(),c.layout.resize();if(b)return b()})},a.prototype.draw=function(){var a,b=this;if(!this.session.connected()){window.location.hash="";return}return $("body").attr("id","chat-page"),$("#container").hide().empty(),$('<div id="alpha" class="sidebar column y-fill">\n  <h2>Buddies <div id="search-roster-icon"></div></h2>\n  <div id="search-roster-form"></div>\n  <ul id="roster" class="selectable scroll y-fill"></ul>\n  <div id="alpha-controls" class="controls">\n    <div id="add-contact"></div>\n    <div id="remove-contact"></div>\n    <div id="edit-contact"></div>\n  </div>\n  <form id="add-contact-form" class="overlay" style="display:none;">\n    <h2>Add Buddy</h2>\n    <input id="add-contact-jid" type="email" maxlength="1024" placeholder="Account name"/>\n    <input id="add-contact-name" type="text" maxlength="1024" placeholder="Real name"/>\n    <fieldset class="buttons">\n      <input id="add-contact-cancel" type="button" value="Cancel"/>\n      <input id="add-contact-ok" type="submit" value="Add"/>\n    </fieldset>\n  </form>\n  <form id="remove-contact-form" class="overlay" style="display:none;">\n    <h2>Remove Buddy</h2>\n    <p id="remove-contact-msg">Select a buddy in the list above to remove.</p>\n    <fieldset class="buttons" style="display:none;">\n      <input id="remove-contact-cancel" type="button" value="Cancel"/>\n      <input id="remove-contact-ok" type="submit" value="Remove"/>\n    </fieldset>\n  </form>\n  <form id="edit-contact-form" class="overlay" style="display:none;">\n    <h2>Update Profile</h2>\n    <p id="edit-contact-jid">Select a buddy in the list above to update.</p>\n    <input id="edit-contact-name" type="text" maxlength="1024" placeholder="Real name" style="display:none;"/>\n    <fieldset class="buttons" style="display:none;">\n      <input id="edit-contact-cancel" type="button" value="Cancel"/>\n      <input id="edit-contact-ok" type="submit" value="Save"/>\n    </fieldset>\n  </form>\n</div>\n<div id="beta" class="primary column x-fill y-fill">\n  <h2 id="chat-title">Select a buddy to chat</h2>\n  <ul id="messages" class="scroll y-fill"></ul>\n  <form id="message-form">\n    <input id="message" name="message" type="text" maxlength="1024" placeholder="Type a message and press enter to send"/>\n  </form>\n</div>\n<div id="charlie" class="sidebar column y-fill">\n  <h2>Notifications</h2>\n  <ul id="notifications" class="scroll y-fill"></ul>\n  <div id="charlie-controls" class="controls">\n    <div id="clear-notices"></div>\n  </div>\n</div>').appendTo("#container"),this.roster(),new Button("#clear-notices",ICONS.no),new Button("#add-contact",ICONS.plus),new Button("#remove-contact",ICONS.minus),new Button("#edit-contact",ICONS.user),$("#message").focus(function(){return $("form.overlay").fadeOut()}),$("#message-form").submit(function(){return b.send()}),$("#clear-notices").click(function(){return $("#notifications li").fadeOut(200)}),$("#add-contact").click(function(){return b.toggleForm("#add-contact-form")}),$("#remove-contact").click(function(){return b.toggleForm("#remove-contact-form")}),$("#edit-contact").click(function(){return b.toggleForm("#edit-contact-form",function(){if(b.currentContact)return $("#edit-contact-jid").text(b.currentContact),$("#edit-contact-name").val(b.session.roster[b.currentContact].name)})}),$("#add-contact-cancel").click(function(){return b.toggleForm("#add-contact-form")}),$("#remove-contact-cancel").click(function(){return b.toggleForm("#remove-contact-form")}),$("#edit-contact-cancel").click(function(){return b.toggleForm("#edit-contact-form")}),$("#add-contact-form").submit(function(){return b.addContact()}),$("#remove-contact-form").submit(function(){return b.removeContact()}),$("#edit-contact-form").submit(function(){return b.updateContact()}),$("#container").fadeIn(200),this.layout=this.resize(),a=function(){return b.layout.resize(),b.layout.resize()},new Filter({list:"#roster",icon:"#search-roster-icon",form:"#search-roster-form",attrs:["data-jid","data-name"],open:a,close:a})},a.prototype.resize=function(){var a,b,c,d,e;return a=$("#alpha"),b=$("#beta"),c=$("#charlie"),e=$("#message"),d=$("#message-form"),new Layout(function(){return c.css("left",a.width()+b.width()),e.width(d.width()-32)})},a}(),$(function(){var a,b,c,d,e,f;f=new Session,d=new NavBar(f),d.draw(),a={Messages:ICONS.chat,Logout:ICONS.power};for(c in a)b=a[c],d.addButton(c,b);return e={"/messages":new ChatPage(f),"/logout":new LogoutPage(f),"default":new LoginPage(f,"/messages/")},(new Router(e)).draw(),d.select($("#nav-link-messages").parent())})}).call(this);